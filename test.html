<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
<style>
  .pm-wrap{display:grid;grid-template-columns:minmax(280px,340px) 1fr;gap:12px}
  .pm-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.06)}
  .pm-side{padding:12px;max-height:78vh;overflow:auto}
  .pm-title{margin:0 0 8px;font:600 16px/1.2 system-ui,Segoe UI,Arial}
  .pm-sub{margin:4px 0 10px;color:#6b7280;font:13px/1.3 system-ui}
  .pm-row{display:flex;gap:8px;margin:6px 0 10px}
  .pm-input{flex:1;border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;font:14px system-ui}
  .pm-btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;font:600 14px/1 system-ui;cursor:pointer}
  .pm-list{list-style:none;margin:0;padding:0}
  .pm-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px;border-radius:10px;border:1px solid #eee;margin-bottom:8px;cursor:pointer}
  .pm-item:hover{background:#f3f4f6}
  .pm-pill{padding:2px 8px;border-radius:999px;font:600 12px/1 system-ui;color:#fff;white-space:nowrap}
  .pm-pill.green{background:#16a34a} .pm-pill.red{background:#dc2626} .pm-pill.blue{background:#2563eb}
  .pm-dist{font:600 13px/1.2 system-ui}
  #pm-map{height:78vh;border-radius:12px}
  .leaflet-popup-content{font:14px/1.3 system-ui}
  @media (max-width:900px){.pm-wrap{grid-template-columns:1fr}#pm-map,.pm-side{max-height:70vh;height:70vh}}

  /* —— Google Places 下拉联想的圆角主题（不要隐藏 powered by Google） —— */
  .pac-container{
    border:1px solid #e5e7eb !important;
    border-radius:12px !important;
    box-shadow:0 8px 24px rgba(0,0,0,.08) !important;
    overflow:hidden !important;
    padding:6px 0 !important;
    z-index:99999 !important;
    font-family:system-ui,Segoe UI,Arial !important;
  }
  .pac-item{
    padding:10px 14px !important;
    border-top:none !important;
    cursor:pointer !important;
  }
  .pac-item:hover,.pac-item.pac-item-selected{background:#f3f4f6 !important}
  .pac-icon{opacity:.65 !important;margin-right:8px !important}
  .pac-item-query{font-weight:700 !important;color:#111 !important}
</style>

<div class="pm-wrap">
  <aside class="pm-card pm-side">
    <h3 class="pm-title">Available bays near you</h3>
    <div id="pm-status" class="pm-sub">Getting location…</div>
    <div class="pm-row">
      <input id="pm-addr" class="pm-input" type="text" placeholder="Address or lat,lon (e.g. -37.81,144.96)" autocomplete="off">
      <button id="pm-search" class="pm-btn">Search</button>
    </div>
    <div class="pm-row">
      <button id="pm-use" class="pm-btn" style="width:100%">Use my location</button>
    </div>
    <ul id="pm-list" class="pm-list"></ul>
  </aside>
  <div id="pm-map" class="pm-card"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<!-- Google Maps Places API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnerd-DjGaopPAZ5nedwk-x06lxhcYhhQ&libraries=places&language=en&region=AU"></script>

<script>
(async function(){
  // ----- Config -----
  const RADIUS_M = 1200;
  const MAX_LIST = 20;
  const PAGE_LIMIT = 100;
  const MAX_PAGES = 80;
  const FALLBACK = {lat:-37.8136, lon:144.9631, label:'Melbourne CBD'};

  const STATUS = document.getElementById('pm-status');
  const LIST = document.getElementById('pm-list');
  const INP = document.getElementById('pm-addr');
  const BTN_S = document.getElementById('pm-search');
  const BTN_U = document.getElementById('pm-use');

  // ----- Utils -----
  const toRad=d=>d*Math.PI/180;
  function distanceM(a,b){
    const R=6371e3,dLat=toRad(b.lat-a.lat),dLon=toRad(b.lon-a.lon);
    const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
  }
  function fmtM(m){return (m>999)?(m/1000).toFixed(2)+' km':Math.round(m)+' m';}
  async function jget(u){const r=await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();}

  // Google 选中的地点（若用户从下拉中选择）
  let gPlaceChosen = null; // {lat, lon, formatted_address}

  // ------- 地址解析：优先 Google 选择；否则 lat,lon；最后 Nominatim 兜底 -------
  async function resolveAddressOrLatLon(q){
    const s = q.trim();
    if (gPlaceChosen && s === gPlaceChosen.formatted_address) {
      return {lat:gPlaceChosen.lat, lon:gPlaceChosen.lon, label:gPlaceChosen.formatted_address};
    }
    const m=s.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if(m) return {lat:+m[1], lon:+m[2], label:'Custom location'};
    const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(s)}`;
    const r=await fetch(url, {headers:{'Accept':'application/json'}});
    const arr=await r.json();
    if(!arr.length) throw new Error('Address not found');
    return {lat:+arr[0].lat, lon:+arr[0].lon, label:arr[0].display_name};
  }

  async function getUserPosition(){
    return new Promise(res=>{
      if(location.protocol!=='https:' || !('geolocation' in navigator)) return res(FALLBACK);
      navigator.geolocation.getCurrentPosition(
        p=>res({lat:p.coords.latitude, lon:p.coords.longitude, label:'Your location'}),
        _=>res(FALLBACK),
        {enableHighAccuracy:true, maximumAge:15000, timeout:8000}
      );
    });
  }

  // ----- Map -----
  const map = L.map('pm-map');
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; OpenStreetMap & CARTO', maxZoom:20
  }).addTo(map);
  const nearGroup = L.layerGroup().addTo(map);

  const statusColor = { unoccupied:'#16a34a', present:'#dc2626' };

  let user = await getUserPosition();
  const userMarker = L.circleMarker([user.lat,user.lon], {
    radius:9,color:'#2563eb',weight:3,fillColor:'#93c5fd',fillOpacity:.9
  }).addTo(map).bindPopup(user.label).openPopup();
  map.setView([user.lat,user.lon], 16);

  // ----- Google Places Autocomplete（地理相关联想，仅 AU，偏向墨尔本） -----
  const melbBounds = new google.maps.LatLngBounds(
    new google.maps.LatLng(-37.835,144.90), // SW
    new google.maps.LatLng(-37.770,144.99)  // NE
  );

  const autocomplete = new google.maps.places.Autocomplete(INP, {
    fields: ['formatted_address','geometry','name','types'],
    bounds: melbBounds,
    strictBounds: false,                       // 仅“偏向”，不强制
    componentRestrictions: { country: 'au' }   // 限制在 AU
    // 想只要“纯地址”可加：types: ['address']（会丢掉 Monash University 等 POI）
  });

  autocomplete.addListener('place_changed', () => {
    const place = autocomplete.getPlace();
    if (!place || !place.geometry || !place.geometry.location) {
      gPlaceChosen = null;
      STATUS.textContent = 'Place not found.';
      return;
    }
    const loc = place.geometry.location;
    const lat = typeof loc.lat === 'function' ? loc.lat() : loc.lat;
    const lon = typeof loc.lng === 'function' ? loc.lng() : loc.lng;

    gPlaceChosen = {
      lat, lon,
      formatted_address: place.formatted_address || place.name || INP.value
    };

    // 直接更新视图
    user = { lat, lon, label: gPlaceChosen.formatted_address };
    userMarker.setLatLng([lat, lon]).setPopupContent(user.label);
    map.setView([lat, lon], 16);
    renderNear();
  });

  // ----- Load ALL sensors -----
  async function loadAllSensors(){
    STATUS.textContent = 'Loading live sensors…';
    let out=[], offset=0, pages=0, total=null;
    try{
      while(true){
        const url = `https://data.melbourne.vic.gov.au/api/explore/v2.1/catalog/datasets/on-street-parking-bay-sensors/records?limit=${PAGE_LIMIT}&offset=${offset}`;
        const data = await jget(url);
        const rows = data.results || [];
        out = out.concat(rows);
        if(total===null) total = data.total_count || out.length;
        offset += PAGE_LIMIT;
        pages++;
        if(offset >= total || pages >= MAX_PAGES) break;
      }
    }catch(e){
      console.error('Sensor load error:', e);
      STATUS.textContent = 'Could not load live sensors.';
      return [];
    }
    STATUS.textContent = `Loaded ${out.length} bays. Finding ones near you…`;
    return out;
  }

  let ALL = await loadAllSensors();
  if(!ALL.length){ return; }

  // ----- Render nearest -----
  function renderNear(){
    LIST.innerHTML=''; nearGroup.clearLayers();
    const withDist = ALL.filter(r=>r.location && typeof r.location.lat==='number' && typeof r.location.lon==='number')
      .map(r => ({ r, dist: distanceM({lat:user.lat,lon:user.lon},{lat:r.location.lat, lon:r.location.lon}) }))
      .filter(x => x.dist <= RADIUS_M);

    if(!withDist.length){ STATUS.textContent = 'No bays found in range.'; return; }

    withDist.sort((a,b)=>{
      const A=(a.r.status_description||'').toLowerCase()==='unoccupied';
      const B=(b.r.status_description||'').toLowerCase()==='unoccupied';
      if(A!==B) return A? -1 : 1;
      return a.dist-b.dist;
    });

    const top = withDist.slice(0, MAX_LIST);
    top.forEach((x,i)=>{
      const r=x.r, lat=r.location.lat, lon=r.location.lon;
      const status=(r.status_description||'').toLowerCase();
      const color = statusColor[status] || '#6b7280';
      const m = L.circleMarker([lat,lon], {
        radius:8,color:'#fff',weight:1.25,fillColor:color,fillOpacity:.95
      }).bindPopup(
        `<div><b>${status==='unoccupied'?'Available bay':'Occupied bay'}</b></div>
         <div><b>Zone:</b> ${r.zone_number ?? '—'}</div>
         <div><b>Distance:</b> ${fmtM(x.dist)}</div>
         <div><small>Updated: ${r.status_timestamp ? new Date(r.status_timestamp).toLocaleString() : 'N/A'}</small></div>
         <div><small>Kerbside ID: ${r.kerbsideid ?? 'N/A'}</small></div>`
      );
      nearGroup.addLayer(m);

      const li=document.createElement('li');
      li.className='pm-item';
      li.innerHTML = `
        <span class="pm-dist">${i+1}. ${fmtM(x.dist)}</span>
        <span class="pm-pill ${status==='unoccupied'?'green':'red'}">${status==='unoccupied'?'Unoccupied':'Present'}</span>
        <span class="pm-pill blue">Zone ${r.zone_number ?? '—'}</span>`;
      li.addEventListener('click',()=>{ map.setView([lat,lon],19,{animate:true}); m.openPopup(); });
      LIST.appendChild(li);
    });

    const bounds = L.latLngBounds(top.map(t=>[t.r.location.lat,t.r.location.lon]).concat([[user.lat,user.lon]]));
    map.fitBounds(bounds.pad(0.2));

    STATUS.textContent = `Showing ${top.length} of ${withDist.length} bays within ${Math.round(RADIUS_M)} m`;
  }

  // initial render
  renderNear();

  // ----- Controls -----
  BTN_U.addEventListener('click', async ()=>{
    STATUS.textContent='Requesting location…';
    user = await getUserPosition();
    gPlaceChosen = null; // 手动定位不依赖 Google 选择
    userMarker.setLatLng([user.lat,user.lon]).setPopupContent(user.label);
    map.setView([user.lat,user.lon], 16);
    renderNear();
  });

  BTN_S.addEventListener('click', doSearch);
  INP.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });

  async function doSearch(){
    const q=INP.value.trim(); if(!q) return;
    STATUS.textContent='Searching…';
    try{
      const loc=await resolveAddressOrLatLon(q);
      user=loc; userMarker.setLatLng([loc.lat,loc.lon]).setPopupContent(loc.label);
      map.setView([loc.lat,loc.lon],16);
      renderNear();
    }catch(e){ STATUS.textContent='Search failed: '+(e.message||''); }
  }

  // refresh sensors every 5 minutes
  setInterval(async ()=>{
    const data = await loadAllSensors();
    if(data.length){ ALL = data; renderNear(); }
  }, 300000);
})();
</script>
